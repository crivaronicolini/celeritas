# Design Document

## 1. Overview

This document outlines the design for the Celeritas challenge project, a web service that allows users to upload PDF documents and ask natural language questions about their content. The system will leverage the OpenAI API to provide answers based on the most relevant document and cite the source. It will also track all user interactions for analytics purposes.

## 2. Requirements

### 2.1. Functional Requirements

- **Document Upload:** Users must be able to upload one or more PDF files via an API endpoint.
- **Question Answering:** Users must be able to submit a natural language question to an API endpoint and receive an answer generated from the uploaded documents.
- **Source Citation:** Every answer must include a citation indicating which PDF document was used as the source.
- **Interaction Logging:** The system must persist all interactions, including:
    - The question, with a timestamp.
    - The generated answer.
    - The source document(s) used.
    - User feedback on the answer (e.g., thumbs up/down).
    - System performance metrics (e.g., response time).
- **Analytics:** An API endpoint must be provided to answer analytical queries, such as:
    - Which documents are queried most frequently?
    - What are the most common questions?
    - How many queries were answered from each PDF in the last week?

### 2.2. Technical Constraints

- **Backend:** Python with a web framework (FastAPI is recommended).
- **AI Service:** OpenAI API must be used for text processing, embeddings, and answer generation.
- **Storage:** Uploaded PDF files can be stored on the local filesystem.

## 3. High-Level API Design

The service will expose a RESTful API with the following primary endpoints:

- `POST /api/documents/`
    - **Description:** Uploads one or more PDF files.
    - **Request Body:** `multipart/form-data` containing the file(s).
    - **Response:** A confirmation with the names and IDs of the successfully processed documents.

- `POST /api/chat/`
    - **Description:** Asks a question and gets an answer.
    - **Request Body:** JSON object: `{ "question": "What is causing global warming?" }`
    - **Response:** JSON object: `{ "answer": "...", "source_document": "...", "interaction_id": "..." }`

- `POST /api/feedback/`
    - **Description:** Submits feedback for a specific interaction.
    - **Request Body:** JSON object: `{ "interaction_id": "...", "feedback": "thumbs_up" }`
    - **Response:** A confirmation status.

- `GET /api/analytics/`
    - **Description:** Retrieves usage analytics.
    - **Query Parameters:** `?query=most_frequent_docs`
    - **Response:** JSON object with the requested analytical data.

## 4. Data Models

The system will use two primary data models to be stored in a relational database (SQLite).

- **`Document`**
    - `id`: (Primary Key) Unique identifier.
    - `filename`: Name of the uploaded file.
    - `filepath`: Location on the filesystem.
    - `uploaded_at`: Timestamp of the upload.

- **`Interaction`**
    - `id`: (Primary Key) Unique identifier.
    - `question`: The question asked by the user.
    - `answer`: The answer generated by the system.
    - `source_document_id`: (Foreign Key) The document used for the answer.
    - `feedback`: User feedback (e.g., 'thumbs_up', 'thumbs_down', `null`).
    - `response_time_ms`: Time taken to generate the response.
    - `created_at`: Timestamp of the interaction.
